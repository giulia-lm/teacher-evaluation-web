<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Docente</title>

    <!-- link a los styles -->
    <link href="../../static/css/base.css" rel="stylesheet">
    <link href="../../static/css/components.css" rel="stylesheet">
    <link href="../../static/css/layout.css" rel="stylesheet">

    <link href="../../static/css/pages/admin-dashboard.css" rel="stylesheet">

    <link rel="icon" type="image/jpg" href="../../static/css/img/admin-icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Fugaz+One&family=Orbitron:wght@400..900&family=VT323&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

  </head>
<body>
    <!-- Navigation -->
    <nav id="navbar">
        <div class="nav-container">
            <a href="{{ url_for('index') }}">
              <div class="logo"><img src="../../static/css/img/admin-icon.png" width="40" height="60">
                 Evaluación Docente
            </div>
          </a>
            <ul class="nav-links">
                <li><a href="{{ url_for('logout') }}">Cerrar sesión</a></li>
                <li><a href="{{ url_for('preguntas_freq') }}">Preguntas frecuentes</a></li>

            </ul>
             <div class="hamburger" id="hamburger">
              <span></span>
              <span></span>
              <span></span>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <ul class="mobile-nav-links">
            <li><a href="{{ url_for('logout') }}">Cerrar sesión</a></li>
            <li><a href="{{ url_for('preguntas_freq') }}">Preguntas frecuentes</a></li>
        </ul>
    </div>

<div id="toast-container"></div>
<div id="toast-container"></div>

<!-- Sección de inicio / Bienvenida -->
<section class="welcome-section">

  <div class="welcome-textBox">
    <h2 class="welcome-text">¡Bienvenidx!</h2>
  </div>

  <div class="welcome-image">
    <img src="../../static/css/img/admin-icon.png" class="avatar">
  </div>
</section>


  <h1>Panel de Administración</h1>
{% block content %}

<section class="admin-dashboard">
  <h2>Usuarixs registradxs</h2>

  <div class="filters">
  <select id="filtro-rol">
    <option value="">Todos los roles</option>
    <option value="alumnx">Alumnxs</option>
    <option value="docente">Docentes</option>
    <option value="admin">Admins</option>
  </select>

  <input id="filtro-creado" name="filtro-creado" type="month" placeholder="YYYY-MM">

  <button id="btn-filtrar-users">Filtrar</button>
  <button id="btn-reset-users">Reset</button>
</div>


  <table id="users-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Matrícula</th>
        <th>Rol</th>
        <th>Fecha creación</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>

    </tbody>
  </table>



<div class="admin-controls">
  <button id="btn-open-add" class="btn-primary">Agregar usuario</button>
</div>
</section>


<div id="user-modal" class="modal">
  <div class="modal-content">
    <h3 id="modal-title">Agregar usuario</h3>
    <form id="user-form">
      <input type="hidden" name="id" id="user-id">

      <label>Nombre
        <input name="name" id="user-name" maxlength="40" minlength="3" required>
      </label>

      <label>Matrícula (Números y letras, máximo 10 caractéres)
        <input name="matricula" id="user-matricula" required maxlength="10" minlength="3">
      </label>

<label>Rol:
  <select id="user-role" name="role" required>
    <option value="">Selecciona rol</option>
    <option value="alumnx">Alumnx</option>
    <option value="docente">Docente</option>
    <option value="admin">Admin</option>
  </select>
</label>

<div id="alumnx-options" style="display:none;">
  <label>Grupo:
    <select id="alumnx-grupo" name="alumnx_grupo">
      {% for g in grupos %}
        <option value="{{ g.id }}">{{ g.name }}</option>
      {% endfor %}
    </select>
  </label>
</div>

<div id="docente-options" style="display:none;">
  <label>Materias impartidas:</label>

  {% for m in materias %}
    <label class="checkbox-container">{{ m.name }}
      <input type="checkbox" name="docente_materias" value="{{ m.id }}"> 
      <span class="checkmark"></span>
    </label>
  {% endfor %}
</div>

      <label>Contraseña (Máximo 15 caractéres)
        <input type="password" id="user-password" name="password" placeholder="Dejar vacío si no hay cambios" maxlength="15" minlength="3">
      </label>

      <div class="form-actions">
        <button type="submit" class="btn-primary" id="user-submit">Guardar</button>
        <button type="button" class="btn-secondary" id="user-cancel">Cancelar</button>
      </div>
    </form>
  </div>
</div>


<section class="materias-dashboard">
  <h2>Materias registradas</h2>

  <div class="filters">
  <select id="filtro-grupo">
    <option value="">Todos los grupos</option>
    {% for g in grupos %}
      <option value="{{ g.id }}">{{ g.name }}</option>
    {% endfor %}
  </select>

  <select id="filtro-docente">
    <option value="">Todos los docentes</option>
    {% for d in docentes %}
      <option value="{{ d.id }}">{{ d.name }}</option>
    {% endfor %}
  </select>

  <button id="btn-filtrar-materias">Filtrar</button>
  <button id="btn-reset-materias">Reset</button>
</div>


  <table id="materias-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Materia</th>
        <th>Docentes</th>
        <th>Grupos</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


<div class="admin-controls">
  <button id="btn-add-materia" class="btn-primary">Agregar materia</button>
</div>
</section>

<div id="materia-modal" class="modal">
  <div class="modal-content">
    <h3 id="materia-modal-title">test</h3>
    <form id="materia-form">
      <input type="hidden" name="id" id="materia-id">

      <label>Nombre
        <input name="name" id="materia-name" maxlength="40" minlength="3" required>
      </label>

<div id="docentes-options">
  <label>Docente que imparte la materia:
    <select id="docente-materia">
      {% for d in docentes %}
        <option value="{{ d.id }}">{{ d.name }}</option>
      {% endfor %}
    </select>
  </label>
</div>

<div id="grupos-options">
  <label>Grupo donde se imparte:
    <select id="grupo" name="grupo">
      {% for g in grupos %}
        <option value="{{ g.id }}">{{ g.name }}</option>
      {% endfor %}
    </select>
  </label>
</div>


      <div class="form-actions">
        <button type="submit" class="btn-primary" id="btn-save-materia">Guardar</button>
        <button type="button" class="btn-secondary" id="materia-cancel">Cancelar</button>
      </div>
    </form>
  </div>
</div>



<section class="respuestas-dashboard">
  <h2>Respuestas de Encuestas</h2>

 <div class="filters">

    <select id="filtro-form">
    <option value="">Todos los formularios</option>
    {% for f in forms %}
      <option value="{{ f.id }}">{{ f.name }}</option>
    {% endfor %}
  </select>

  <select id="filtro-alumnx">
    <option value="">Todos lxs alumnxs</option>
    {% for a in alumnxs %}
      <option value="{{ a.id }}">{{ a.name }}</option>
    {% endfor %}
  </select>

  <input id="filtro-fecha" name="filtro-fecha" type="month" placeholder="YYYY-MM">

  <button id="btn-filtrar-respuestas">Filtrar</button>
  <button id="btn-reset-respuestas">Reset</button>
</div> 

<table id="responses-table" class="responses-table">
  <thead>
    <tr class="responses-tr">
      <th>Nombre del Form</th>
      <th>Alumno</th>
      <th>Fecha</th>
      <th>Respuestas</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</section>

{% endblock %}

<div class="download_res_section">
  <a href="{{ url_for('download_admin_report') }}" class="download_res_button">
    Descargar reporte de respuestas PDF
  </a>
</div>




<!-- Footer -->
  <footer class="footer">
     <div class="container">
      <div class="row">
        <div class="footer-col">
          <h4>Contáctanos</h4>
          <ul>
            <li><a href="mailto:evaluaciondocente@uaem.edu.mx" target="_blank" rel="noopener noreferrer">evaluaciondocente@uaem.edu.mx</a></li>
            <li><a href="tel:7770000000" target="_blank" rel="noopener noreferrer"> (777) 000 0000 (Llamadas)</a></li>
          </ul>
        </div>

        <div class="footer-col">
          <h4>Síguenos</h4>
          <div class="social-links">
            <a href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer">
              <img src="../../../static/css/img/fb-icon.png" alt="Facebook">
            </a>
            <a href="https://www.instagram.com/" target="_blank" rel="noopener noreferrer">
              <img src="../../../static/css/img/ig-icon.png" alt="Instagram">
            </a>
          </div>
        </div>
      </div>
     </div>
  </footer>
<script src="{{ url_for('static', filename='js/menu.js') }}"></script>

<script src="{{ url_for('static', filename='js/dashboard-admin.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard-materias.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard-respuestas.js') }}"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/monthSelect.js"></script>
<script>

  const FLATPICKR_JS = 'https://cdn.jsdelivr.net/npm/flatpickr';
  const MONTH_PLUGIN_JS = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js';

  function supportsInputMonth() {
    const i = document.createElement('input');
    i.setAttribute('type', 'month');
    return i.type === 'month';
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      // Si ya cargado, resuelve
      if (Array.from(document.scripts).some(s => s.src && s.src.includes(src))) {
        return resolve();
      }
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = () => resolve();
      s.onerror = (e) => reject(new Error('Error cargando script: ' + src));
      document.head.appendChild(s);
    });
  }

  async function ensureFlatpickrAndPlugin() {
    // cargar flatpickr si no existe
    if (typeof window.flatpickr !== 'function') {
      try {
        await loadScript(FLATPICKR_JS);
        console.debug('flatpickr cargado');
      } catch (e) {
        console.error(e);
        throw e;
      }
    }
    // cargar plugin monthSelect si no existe
    if (typeof window.monthSelectPlugin !== 'function') {
      try {
        await loadScript(MONTH_PLUGIN_JS);
        console.debug('monthSelect plugin cargado');
      } catch (e) {
        console.error(e);
        throw e;
      }
    }
  }

  function initMonthPickers(selector = 'input[type="month"]') {
    const elems = document.querySelectorAll(selector);
    elems.forEach(el => {
      // si ya fue inicializado (atributo data-fp), saltar
      if (el.dataset.fpInitialized === '1') return;
      try {
        flatpickr(el, {
          dateFormat: "Y-m",
          altInput: true,
          altFormat: "F Y",
          // plugin: monthSelect
          plugins: [ new monthSelectPlugin({
              shorthand: false,
              dateFormat: "Y-m",
              altFormat: "F Y"
          }) ],
          onReady: function(selectedDates, dateStr, instance) {
            el.dataset.fpInitialized = '1';
          },
          onChange: function(selectedDates, dateStr, instance) {
            // por si quieres que cierre inmediatamente:
            // instance.close();
          }
        });
      } catch (err) {
        console.error('Error inicializando flatpickr en', el, err);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Si el navegador soporta input[type="month"], lo dejamos nativo (Chrome/Opera)
    if (supportsInputMonth()) {
      console.debug('Navegador soporta input[type=month] — no se aplica polyfill.');
      return;
    }

    // En Firefox: convertir inputs type=month a text y aplicar flatpickr
    const elems = document.querySelectorAll('input[type="month"]');
    if (!elems.length) return;

    elems.forEach(el => {
      el.type = 'text'; // evita comportamiento inesperado
    });

    try {
      await ensureFlatpickrAndPlugin();
      initMonthPickers('input[type="text"][name="filtro-creado"], input[type="text"][name="filtro-fecha"], input[type="text"][id="filtro-creado"], input[type="text"][id="filtro-fecha"], input[type="text"].month-polyfill');

    } catch (e) {
      console.error('No fue posible inicializar month picker polyfill:', e);
    }
  });
</script>

</body>
</html>